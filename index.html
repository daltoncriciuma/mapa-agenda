function exportaAgendaComCoordenadas() {
  var calendarioId = 'a3c407aac2505d4bbdb4c66ca99d0283219630c098987ba04692ab63a2fd329d@group.calendar.google.com';
  var inicio = new Date();
  var fim = new Date();
  fim.setMonth(fim.getMonth() + 12);
  var eventos = CalendarApp.getCalendarById(calendarioId).getEvents(inicio, fim);
  var lista = [];
  eventos.forEach(function(evento) {
    var local = evento.getLocation();
    var lat = "", lng = "";
    if (local && local.match(/^https:\/\/goo\.gl\/maps\//)) {
      var coords = coordenadasDeShortLink(local);
      if (coords) { lat = coords.lat; lng = coords.lng; }
    }
    lista.push({
      titulo: evento.getTitle(),
      descricao: evento.getDescription(),
      local: local,
      link: 'https://calendar.google.com/calendar/event?eid=' + evento.getId(),
      data: evento.getStartTime().toISOString(),
      latitude: lat,
      longitude: lng
    });
  });
  var arquivos = DriveApp.getFilesByName('pinos.json');
  if (arquivos.hasNext()) {
    var antigo = arquivos.next();
    antigo.setTrashed(true);
  }
  var file = DriveApp.createFile('pinos.json', JSON.stringify(lista, null, 2), MimeType.PLAIN_TEXT);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
}

// Função para pegar latitude/longitude do shortlink do Maps
function coordenadasDeShortLink(shortUrl) {
  try {
    var options = { followRedirects: false, muteHttpExceptions: true };
    var response = UrlFetchApp.fetch(shortUrl, options);
    var headers = response.getAllHeaders();
    var redirectUrl = headers['Location'] || headers['location'];
    if (!redirectUrl) return null;
    var regex = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
    var match = regex.exec(redirectUrl);
    if (match) {
      return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
    }
  } catch (e) {}
  return null;
}
