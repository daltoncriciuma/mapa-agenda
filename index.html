<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Compromissos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map { height: 94vh; width: 100%; }
    .label-nome {
      color: red;
      font-size: 10px;
      white-space: nowrap;
    }
    .leaflet-top.leaflet-left {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    .leaflet-control-container .leaflet-top {
      pointer-events: none;
    }
    #mesFiltro {
      pointer-events: auto;
      font-size: 14px;
      padding: 4px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    let map;
    let todosPontos = [];

    function carregarGeoJSON() {
      fetch('https://raw.githubusercontent.com/daltoncriciuma/mapa-agenda/main/pinos.json')
        .then(response => response.json())
        .then(data => {
          map = L.map('map', {
            center: [-28.65, -49.25],
            zoom: 9,
            layers: [
              L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
              })
            ]
          });

          adicionarFiltro(data);
          renderizarPontos(data.features);
        })
        .catch(error => {
          console.error('Erro ao carregar o arquivo JSON:', error);
          alert('Erro ao carregar os dados do mapa!');
        });
    }

    function renderizarPontos(features) {
      todosPontos.forEach(obj => map.removeLayer(obj.marker));
      todosPontos = [];

      features.forEach(feature => {
        const { coordinates } = feature.geometry;
        const { titulo, data_inicio, descricao, localizacao } = feature.properties;
        const dataObj = new Date(data_inicio);
        const mes = dataObj.getMonth();

        const popupContent = `
          <b>${titulo}</b><br>
          <i>${data_inicio}</i><br>
          <p>${descricao}</p><br>
          <a href="${localizacao}" target="_blank">Ver localização</a>
        `;

        const marker = L.marker([coordinates[1], coordinates[0]], {
          icon: L.icon({
            iconUrl: 'https://chart.googleapis.com/chart?chst=d_map_pin_icon&chld=pin|FF0000',
            iconSize: [30, 45],
            iconAnchor: [15, 42],
            popupAnchor: [0, -36]
          })
        }).addTo(map).bindPopup(popupContent);

        const nomeResumido = titulo.match(/\d+ - ([^\s]+)(?: ([^\s]+))?/);
        const nome = nomeResumido ? `${nomeResumido[1]} ${nomeResumido[2] || ''}` : '';

        const label = L.divIcon({
          className: 'label-nome',
          html: nome,
          iconSize: [100, 10],
          iconAnchor: [0, 0]
        });

        const labelMarker = L.marker([coordinates[1], coordinates[0]], { icon: label }).addTo(map);

        todosPontos.push({ marker, labelMarker, mes });
      });
    }

    function adicionarFiltro(data) {
      const select = document.createElement('select');
      select.id = 'mesFiltro';
      select.innerHTML = `<option value="todos">Todos os meses</option>` +
        [...new Set(data.features.map(f => new Date(f.properties.data_inicio).getMonth()))]
          .sort((a, b) => a - b)
          .map(m => `<option value="${m}">${new Date(0, m).toLocaleString('pt-BR', { month: 'long' })}</option>`) // pt-BR meses
          .join('');

      select.addEventListener('change', e => {
        const mesSelecionado = e.target.value;
        todosPontos.forEach(obj => {
          const mostrar = mesSelecionado === 'todos' || obj.mes == mesSelecionado;
          if (mostrar) {
            obj.marker.addTo(map);
            obj.labelMarker.addTo(map);
          } else {
            map.removeLayer(obj.marker);
            map.removeLayer(obj.labelMarker);
          }
        });
      });

      document.querySelector('.leaflet-top.leaflet-left').appendChild(select);
    }

    document.addEventListener('DOMContentLoaded', carregarGeoJSON);
  </script>
</body>
</html>
