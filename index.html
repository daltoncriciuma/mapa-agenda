<select id="filtroMes">
  <option value="">Todos os meses</option>
</select>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '&copy; Esri, DigitalGlobe'
});
const mapa = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
});
const map = L.map('map', {
  center: [-28.626, -49.242],
  zoom: 11,
  layers: [satelite]
});
L.control.layers({ "Mapa": mapa, "Satélite": satelite }, null, { position: "bottomright" }).addTo(map);

let allMarkers = [];

function filtrarPorMes(mes) {
  allMarkers.forEach(obj => {
    const dt = obj.data_inicio ? new Date(obj.data_inicio) : null;
    if (!mes || !dt || dt.getMonth() + 1 == mes) {
      obj.marker.addTo(map);
      obj.marker._icon && (obj.marker._icon.style.display = "");
    } else {
      map.removeLayer(obj.marker);
    }
  });
}

fetch('https://raw.githubusercontent.com/daltoncriciuma/mapa-agenda/main/pinos.json')
  .then(response => response.json())
  .then(data => {
    // Gera meses únicos
    const meses = new Set();
    data.features.forEach(feature => {
      const dt = feature.properties.data_inicio ? new Date(feature.properties.data_inicio) : null;
      if (dt && !isNaN(dt)) meses.add(`${(dt.getMonth()+1).toString().padStart(2,'0')}/${dt.getFullYear()}`);
    });

    // Popular filtro meses
    const filtro = document.getElementById('filtroMes');
    Array.from(meses).sort().forEach(m => {
      const [mes, ano] = m.split('/');
      filtro.innerHTML += `<option value="${mes}">${mes}/${ano}</option>`;
    });

    // Cria pinos vermelhos + labels
    data.features.forEach(feature => {
      const { coordinates } = feature.geometry;
      const { titulo, data_inicio, descricao, localizacao } = feature.properties;
      const markerIcon = L.icon({
        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        iconSize: [22, 32],
        iconAnchor: [11, 32],
        popupAnchor: [1, -30]
      });
      // Nome ao lado do pino
      const nomesSplit = (titulo || "").trim().split(" ");
      const code = nomesSplit[0] || '';
      const nome1 = nomesSplit[1] || '';
      const nome2 = nomesSplit[2] || '';
      const labelText = `<span>${code} ${nome1} ${nome2}</span>`;
      const marker = L.marker([coordinates[1], coordinates[0]], { icon: markerIcon }).addTo(map);
      marker.bindTooltip(labelText, {
        permanent: true,
        direction: "right",
        offset: [15, -5],
        className: "custom-label"
      }).openTooltip();

      marker.bindPopup(`
        <b>${titulo}</b><br>
        <i>${formatarData(data_inicio)}</i><br>
        <pre style="white-space:pre-wrap; font-size:12px; font-family:inherit; margin:0 0 5px 0;">${descricao}</pre>
        <input style="width:95%; font-size:12px;" type="text" value="${localizacao}" readonly onclick="this.select()" /><br>
        <a href="${localizacao}" target="_blank">Abrir no mapa</a>
      `);

      allMarkers.push({ marker, data_inicio });
    });

    filtro.onchange = () => {
      const mes = filtro.value;
      filtrarPorMes(mes);
    };
  });

function formatarData(isoString) {
  if (!isoString) return "";
  const data = new Date(isoString);
  if (isNaN(data)) return isoString;
  const dia = ("0" + data.getDate()).slice(-2);
  const mes = ("0" + (data.getMonth() + 1)).slice(-2);
  const ano = String(data.getFullYear()).slice(-2);
  return `${dia}/${mes}/${ano}`;
}
</script>
