<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Compromissos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    #map { height: 92vh; width: 100%; }
    .custom-label {
      background: white;
      padding: 2px 7px;
      border-radius: 9px;
      box-shadow: 0 0 4px #0002;
      font-size: 12px;
      margin-left: 8px;
      position: relative;
      top: -4px;
      display: inline-block;
      font-family: 'Arial',sans-serif;
    }
    .leaflet-marker-icon.custom-pin {
      filter: hue-rotate(-20deg) saturate(2) brightness(0.95);
      width: 24px !important;
      height: 32px !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Camada satélite padrão + camada mapa
    const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; Esri, DigitalGlobe'
    });
    const mapa = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });

    // Cria o mapa
    const map = L.map('map', {
      center: [-28.626, -49.242],
      zoom: 11,
      layers: [satelite] // Satélite padrão
    });

    // Botão de troca de camada no canto inferior direito
    L.control.layers(
      { "Mapa": mapa, "Satélite": satelite }, // ordem: mapa, satélite
      null,
      { position: "bottomright" }
    ).addTo(map);

    // Função de carregar pinos do GeoJSON
    fetch('https://raw.githubusercontent.com/daltoncriciuma/mapa-agenda/main/pinos.json')
      .then(response => response.json())
      .then(data => {
        data.features.forEach(feature => {
          const { coordinates } = feature.geometry;
          const { titulo, data_inicio, descricao, localizacao } = feature.properties;

          // Cria pino vermelho customizado (Leaflet padrão, mas menor)
          const markerIcon = L.icon({
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
            iconSize: [22, 32],
            iconAnchor: [11, 32],
            popupAnchor: [1, -30]
          });

          // Label ao lado do pino
          const nomesSplit = titulo.trim().split(" ");
          let code = nomesSplit[0] || '';
          let nome1 = nomesSplit[1] || '';
          let nome2 = nomesSplit[2] || '';
          const labelText = `<span class="custom-label">${code} ${nome1} ${nome2}</span>`;

          // Marker + label
          const marker = L.marker([coordinates[1], coordinates[0]], { icon: markerIcon })
            .addTo(map);

          // Adiciona o nome ao lado do pino com tarja branca, afastado
          marker.bindTooltip(labelText, {
            permanent: true,
            direction: "right",
            offset: [8, -10],
            className: "custom-label"
          }).openTooltip();

          // Popup completo ao clicar
          marker.bindPopup(`
            <b>${titulo}</b><br>
            <i>${formatarData(data_inicio)}</i><br>
            <pre style="white-space:pre-wrap; font-size:12px; font-family:inherit; margin:0 0 5px 0;">${descricao}</pre>
            <input style="width:95%; font-size:12px;" type="text" value="${localizacao}" readonly onclick="this.select()" /><br>
            <a href="${localizacao}" target="_blank">Abrir no mapa</a>
          `);
        });
      })
      .catch(error => {
        console.error('Erro ao carregar o arquivo JSON:', error);
        alert('Erro ao carregar os dados do mapa!');
      });

    // Função para formatar data para dd/mm/yy
    function formatarData(isoString) {
      if (!isoString) return "";
      const data = new Date(isoString);
      if (isNaN(data)) return isoString;
      const dia = ("0" + data.getDate()).slice(-2);
      const mes = ("0" + (data.getMonth() + 1)).slice(-2);
      const ano = String(data.getFullYear()).slice(-2);
      return `${dia}/${mes}/${ano}`;
    }
  </script>
</body>
</html>
